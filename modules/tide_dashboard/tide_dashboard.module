<?php

/**
 * @file
 * Tide Dashboard.
 */

use Drupal\Core\Breadcrumb\Breadcrumb;
use Drupal\Core\Link;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\user\UserInterface;

/**
 * Implements hook_toolbar_alter().
 *
 * Hide Workbench menu from users without the custom permission.
 *
 * @see workbench_toolbar()
 */
function tide_dashboard_toolbar_alter(&$items) {
  $items['administration']['#attached']['library'][] = 'tide_dashboard/toolbar.icons';
  $user = \Drupal::currentUser();
  if (!$user->hasPermission('access workbench menu')) {
    unset($items['workbench']);
  }
}

/**
 * Callback for workbench.content route title.
 *
 * @return \Drupal\Core\StringTranslation\TranslatableMarkup
 *   The route title.
 */
function _tide_dashboard_workbench_content_title_callback() {
  return t('Dashboard');
}

/**
 * Implements hook_user_login().
 */
function tide_dashboard_user_login(UserInterface $account) {
  $request = \Drupal::service('request_stack')->getCurrentRequest();
  $uid = $account->id();

  $module_handler = \Drupal::service('module_handler');
  if ($module_handler->moduleExists('tfa')) {
    // Check which roles are forced to use tfa.
    $tfa_config = \Drupal::config('tfa.settings');
    $required_roles = $tfa_config->get('required_roles') ?: [];

    // Check if the current user has any of the required roles.
    $user_roles = $account->getRoles();
    $is_required = (bool) array_intersect($required_roles, $user_roles);

    // If they ARE required to have it, check if they've actually set it up.
    if ($is_required) {
      $user_data = \Drupal::service('user.data');
      $tfa_settings = $user_data->get('tfa', $uid, 'tfa_user_settings');
      // Check 'status' AND ensure the 'plugins' array is not empty.
      $has_active_plugins = !empty($tfa_settings['data']['plugins']);
      $is_enabled = !empty($tfa_settings['status']) && $tfa_settings['status'] == 1;

      // If user don't have active plugins, they haven't finished setup.
      if (!$is_enabled || !$has_active_plugins) {
        $request->query->set('destination', "/user/$uid/security/tfa");
        return;
      }
    }
  }

  // Fallback: If not required or already setup, go to workbench.
  if (!$request->query->has('destination')) {
    $request->query->set('destination', '/admin/workbench');
  }
}

/**
 * Implements hook_system_breadcrumb_alter().
 */
function tide_dashboard_system_breadcrumb_alter(Breadcrumb &$breadcrumb, RouteMatchInterface $route_match, array $context) {
  $links = $breadcrumb->getLinks();

  if (!empty($links)) {
    // Check if the first link is the Home link.
    if ($links[0]->getUrl()->isRouted() && $links[0]->getUrl()->getRouteName() === '<front>') {

      $new_url = Url::fromUserInput('/admin/workbench');
      $new_link = Link::fromTextAndUrl($links[0]->getText(), $new_url);

      // Swap the first link to workbench.
      $links[0] = $new_link;

      $reflection = new \ReflectionClass($breadcrumb);
      $property = $reflection->getProperty('links');
      $property->setAccessible(TRUE);
      $property->setValue($breadcrumb, $links);
    }
  }
}
